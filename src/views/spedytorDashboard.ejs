<script>
    document.addEventListener('DOMContentLoaded', () => {
        const socket = io();
        const userId = '<%= user.id %>';
        const userRole = '<%= user.role %>';
        
        // PrzeÅ‚adowywanie okna, gdy driver zaakceptuje zaproszenie
        if (userRole === 'spedytor') {
            socket.on('driver_accepted', () => {
                window.location.reload();
            });
        }
    });

    function assignDriver(jobId) {
    const driverId = document.getElementById(`driverSelect_${jobId}`).value;
    if (!driverId) {
        alert('Wybierz kierowcÄ™');
        return;
    }

    fetch(`/api/job/assign-driver/${driverId}/${jobId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (response.ok) {
            window.location.reload();
        } else {
            throw new Error('BÅ‚Ä…d podczas przypisywania kierowcy');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(error.message);
    });
}

</script>
<div id="spedytor-dashboard">

    <div class="drivers-section">
        <div class="available-drivers">
            <h3>DostÄ™pni kierowcy</h3>
            <div class="drivers-grid">
                <% freeDrivers.forEach(driver => { %>
                    <div class="driver-card">
                        <div class="driver-name"><%= driver.name %> <%= driver.surname %></div>
                        <div class="status-indicator <%= driver.isOnline ? 'online' : 'offline' %>" 
                             data-user-status="<%= driver._id %>">
                            <%= driver.isOnline ? 'ðŸŸ¢' : 'ðŸ”´' %>
                        </div>
                        <form action="/api/job/invite-driver/<%= driver._id %>" method="POST">
                            <button type="submit" class="btn-invite">ZaproÅ› do zespoÅ‚u</button>
                        </form>
                    </div>
                <% }) %>
            </div>
        </div>

        <div class="managed-drivers">
            <h3>MÃ³j zespÃ³Å‚</h3>
            <div class="drivers-grid">
                <% managedDrivers.forEach(driver => { %>
                    <div class="driver-card">
                        <div class="driver-name">
                            <%= driver.name %> <%= driver.surname %>
                        </div>
                        <div class="status-indicator <%= driver.isOnline ? 'online' : 'offline' %>" 
                             data-user-status="<%= driver._id %>">
                            <%= driver.isOnline ? 'ðŸŸ¢' : 'ðŸ”´' %>
                        </div>
                        <form action="/api/job/remove-driver/<%= driver._id %>" method="post">
                            <button type="submit">UsuÅ„ kierowcÄ™</button>
                        </form>
                        
                    </div>
                <% }) %>
            </div>
        </div>
    </div>

    <table id="accepted-jobs" class="jobs-table">
        <h3>PrzyjÄ™te zlecenia</h3>
        <thead>
            <tr>
                <th>Cena</th>
                <th>Waga</th>
                <th>Wymiary</th>
                <th>Adres odbioru</th>
                <th>Data odbioru</th>
                <th>Adres dostawy</th>
                <th>Data dostawy</th>
                <th>OdlegÅ‚oÅ›Ä‡</th>
                <th>Status</th>
                <th>Data utworzenia</th>
                <th>Akcje</th>
            </tr>
        </thead>
        <tbody>
            <% acceptedJobs.forEach(job => { %>
                <tr>
                    <td><%= job.price %> PLN</td>
                    <td><%= job.weight %> kg</td>
                    <td><%= job.dimensions.length %>x<%= job.dimensions.width %>x<%= job.dimensions.height %> cm</td>
                    <td><%= job.pickup.address %></td>
                    <td><%= new Date(job.pickup.date).toLocaleString() %></td>
                    <td><%= job.delivery.address %></td>
                    <td><%= new Date(job.delivery.date).toLocaleString() %></td>
                    <td><%= job.distance %> km</td>
                    <td class="status-<%= job.status %>"><%= job.status %></td>
                    <td><%= new Date(job.createdAt).toLocaleString() %></td>
                    <td>
                        <select id="driverSelect_<%= job._id %>" name="driverId" required>
                            <option value="">Wybierz kierowcÄ™</option>
                            <% managedDrivers.forEach(driver => { %>
                                <option value="<%= driver._id %>">
                                    <%= driver.name %> <%= driver.surname %>
                                </option>
                            <% }); %>
                        </select>
                        <button onclick="assignDriver('<%= job._id %>')" class="assign-btn">Ustaw</button>
                    </td>
                </tr>
            <% }); %>
        </tbody>
    </table>

    <table id="all-jobs" class="jobs-table">
        <h3>Wszystkie zlecenia</h3>
        <thead>
            <tr>
                <th>Cena</th>
                <th>Waga</th>
                <th>Wymiary</th>
                <th>Adres odbioru</th>
                <th>Data odbioru</th>
                <th>Adres dostawy</th>
                <th>Data dostawy</th>
                <th>OdlegÅ‚oÅ›Ä‡</th>
                <th>Status</th>
                <th>Data utworzenia</th>
                <th>Akcje</th>
            </tr>
        </thead>
        <tbody>
    <% jobs.forEach(job => { %>
        <tr>
            <td><%= job.price %> PLN</td>
            <td><%= job.weight %> kg</td>
            <td><%= job.dimensions.length %>x<%= job.dimensions.width %>x<%= job.dimensions.height %> cm</td>
            <td><%= job.pickup.address %></td>
            <td><%= new Date(job.pickup.date).toLocaleString() %></td>
            <td><%= job.delivery.address %></td>
            <td><%= new Date(job.delivery.date).toLocaleString() %></td>
            <td><%= job.distance %> km</td>
            <td class="status-<%= job.status %>"><%= job.status %></td>
            <td><%= new Date(job.createdAt).toLocaleString() %></td>
            <td>
                <% if (job.status === 'active') { %>
                    <form action="/api/job/<%= job._id %>/accept" method="POST">
                        <button type="submit" class="accept-btn">Przyjmij zlecenie</button>
                    </form>
                <% } %>
            </td>
        </tr>
    <% }); %>
</tbody>
</table>
</div>