
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();
            const userId = '<%= user.id %>';
            const userRole = '<%= user.role %>';
            
            socket.emit('user_connected', userId);
            socket.userId = userId;

            socket.on('connect', () => {
                console.log('Socket connected, joining room:', userId);
                socket.emit('user_connected', userId);
            });

            socket.on('connect_error', (error) => {
                console.error('Socket connection error:', error);
            });

            socket.on('connect', () => {
                console.log('Socket connected, joining room:', userId);
                socket.emit('user_connected', userId);
            });

            socket.on('connect_error', (error) => {
                console.error('Socket connection error:', error);
            });

            // Status update handling
            socket.on('status_update', ({ userId, isOnline }) => {
                const statusElements = document.querySelectorAll(`[data-user-status="${userId}"]`);
                statusElements.forEach(element => {
                    element.textContent = isOnline ? 'üü¢' : 'üî¥';
                    element.className = `status-indicator ${isOnline ? 'online' : 'offline'}`;
                });
            });

            // KIEROWCA
            if (userRole === 'kierowca') {
                // Je≈õli otrzyma nowe zaproszenie to ma siƒô dodaƒá
                socket.on('new_invitation', (data) => {
                    const invitationsList = document.querySelector('.invitations-section');
                    if (invitationsList) {
                        // Skasowanie komunikatu o tym, ≈ºe nie ma zaprosze≈Ñ
                        const noInvitationsMsg = invitationsList.querySelector('p');
                        if (noInvitationsMsg) {
                            noInvitationsMsg.remove();
                        }

                        const newInvitation = `
                            <div class="invitation-card">
                                <p>Spedytor: ${data.spedytorEmail}</p>
                                <div class="invitation-actions">
                                    <form action="/api/job/respond-invitation/${data.invitation._id}" method="POST" style="display: inline;">
                                        <input type="hidden" name="response" value="accept">
                                        <button type="submit" class="btn-accept">Akceptuj</button>
                                    </form>
                                    <form action="/api/job/respond-invitation/${data.invitation._id}" method="POST" style="display: inline;">
                                        <input type="hidden" name="response" value="reject">
                                        <button type="submit" class="btn-reject">Odrzuƒá</button>
                                    </form>
                                </div>
                            </div>
                        `;
                        invitationsList.insertAdjacentHTML('afterbegin', newInvitation);
                        console.log('New invitation added to DOM');
                    } else {
                        console.error('Invitations section not found');
                    }
                });
            }

            // SPEDYTOR
            if (userRole === 'spedytor') {
                // Powiadamianie o tym, ≈ºe spedytor otrzyma≈Ç zaproszenie
                socket.on('invitation_response', (data) => {
                    const status = data.response === 'accept' ? 'zaakceptowa≈Ç' : 'odrzuci≈Ç';
                });
            }

        });
    </script>
</head>
<body>
    <nav class="navbar">
        <a href="/" class="brand">CargoLink</a>
        <div class="dashboard-type">
            <%= user.role %> Dashboard
        </div>
        <div class="user-section">
            <span class="user-info">
                <%= user.name %> <%= user.surname %>
            </span>
            <form action="/api/auth/logout" method="POST" style="margin: 0;">
                <button type="submit" class="logout-btn">Wyloguj</button>
            </form>
        </div>
    </nav>
    <!-- <form action="/api/auth/logout" method="POST">
        <button type="submit">Logout</button>
    </form> -->

    <!-- <main class="main-content">
        <header>
            <h1>Dashboard</h1>
        </header> -->
        
        <%- body %>
    </main>
</body>
</html>